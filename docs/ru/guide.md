# Sure

Библиотека предоставляет механизм кооперативного переключения контекста (нелокальной передачи управления) для реализации stackful корутин и файберов.

## `ExecutionContext`

Сохраненный контекст остановленного исполнения представлен классом [`ExecutionContext`](sure/context.hpp) и включает:
- Регистры процессора
- Контекст санитайзера
- Контекст исключения

## Операции

`ExecutionContext` поддерживает две операции:
- _установка_ (`Setup`) и
- _переключение_ (`SwitchTo` + `ExitTo`) контекста.

### Переключение контекста

Выглядит так: `current.SwitchTo(target)`

Текущий контекст исполнения на процессоре будет сохранен в `current`, после чего на процессоре активируется контекст `target`.

Активируемый контекст `target` 
- либо ранее был сохранен с помощью `SwitchTo` (стоят слева от вызова, в позиции `this`),
- либо был установлен "вручную" с помощью метода `Setup`.

### Установка контекста

Метод `ExecutionContext::Setup` принимает два аргумента:
- `stack` – диапазон памяти для стека, на котором будет работать новое исполнение, в виде `MutableMemView`
- `trampoline` – указатель на реализацию интерфейса [`ITrampoline`](sure/trampoline.hpp) с единственным методом `Run`.

После переключения через `SwitchTo` в установленный через `Setup` контекст исполнение начнется с вызова `trampoline->Run()` на стеке `stack`.

Пример использования: [TinyFibers](https://gitlab.com/Lipovsky/tinyfibers/)

### `ExitTo`

При последнем переключении из контекста (т.е. в конце трамплина корутины / файбера) используйте `ExitTo` вместо `SwitchTo`.

Этот граничный случай необходим для корректной работы проверок в [AddressSanitizer](https://clang.llvm.org/docs/AddressSanitizer.html).
